using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Avalonia.Controls;
using Avalonia.Platform.Storage;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using DocumentExtractor.Desktop.Models;
using DocumentExtractor.Core.Interfaces;
using DocumentExtractor.Core.Models;
using DocumentExtractor.Services;
using DocumentExtractor.Data.Context;
using Microsoft.Extensions.Logging;

namespace DocumentExtractor.Desktop.Services;

/// <summary>
/// Global AI Assistant service that provides context-aware chat functionality across all tabs.
/// Extracts and centralizes chat logic for universal access throughout the application.
/// </summary>
public partial class GlobalAIAssistantService : ObservableObject
{
    private readonly IDocumentProcessor _documentProcessor;
    private readonly DocumentExtractionContext _context;
    private readonly AIService _aiService;

    #region Observable Properties

    [ObservableProperty]
    private ObservableCollection<ChatMessage> _messages = new();

    [ObservableProperty]
    private string _currentMessage = string.Empty;

    [ObservableProperty]
    private bool _canSendMessage = true;

    [ObservableProperty]
    private bool _isProcessing = false;

    [ObservableProperty]
    private string _statusMessage = "AI Assistant ready to help!";

    [ObservableProperty]
    private string _currentContext = "Dashboard";

    [ObservableProperty]
    private bool _isVisible = false;

    #endregion

    #region Events

    /// <summary>
    /// Event fired when the current context changes (e.g., user switches tabs)
    /// </summary>
    public event Action<string>? ContextChanged;

    /// <summary>
    /// Event fired when a new message is added to chat
    /// </summary>
    public event Action<ChatMessage>? MessageAdded;

    #endregion

    #region Constructor

    public GlobalAIAssistantService(DocumentExtractionContext context)
    {
        try
        {
            _context = context ?? throw new ArgumentNullException(nameof(context));
            
            // Initialize document processor with simple logging
            var textExtractorLogger = new SimpleConsoleLogger<TesseractTextExtractor>();
            var textExtractor = new TesseractTextExtractor(textExtractorLogger);
            var processorLogger = new SimpleConsoleLogger<RealDocumentProcessor>();
            _documentProcessor = new RealDocumentProcessor(textExtractor, _context, processorLogger);
            
            // Initialize AI Service for intelligent responses
            _aiService = new AIService();
            
            // Initialize messages collection
            Messages = new ObservableCollection<ChatMessage>();
            
            Console.WriteLine("üåê GlobalAIAssistantService initialized successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error initializing GlobalAIAssistantService: {ex.Message}");
            StatusMessage = $"AI Assistant initialization error: {ex.Message}";
        }
    }

    #endregion

    #region Commands

    [RelayCommand]
    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(CurrentMessage))
        {
            await SendMessageAsync(CurrentMessage);
        }
    }

    [RelayCommand]
    private async Task SendMessageWithParameter(string message)
    {
        if (!string.IsNullOrWhiteSpace(message))
        {
            await SendMessageAsync(message);
        }
    }

    [RelayCommand]
    private void Toggle()
    {
        ToggleVisibility();
    }

    #endregion

    #region Public Methods

    /// <summary>
    /// Initialize the AI Assistant with a context-aware welcome message
    /// </summary>
    public void InitializeWelcomeMessage()
    {
        if (Messages.Count == 0)
        {
            AddMessage("AI Assistant", 
                "üëã **Hello! I'm your Global AI Assistant!**\n\n" +
                "I'm available on ALL tabs to help you with:\n\n" +
                "üó∫Ô∏è **Template Mapping**: Click-to-teach field mapping, Excel layouts\n" +
                "üìä **Dashboard**: Processing stats, document insights\n" +
                "üìã **Documents**: Upload, review, re-process documents\n" +
                "üìÅ **Templates**: Manage template library, categorization\n" +
                "ü§ñ **AI Learning**: Conversational document teaching\n\n" +
                "üí° **Smart Help**: I provide context-aware assistance based on where you are!\n\n" +
                "What can I help you with today?", 
                ChatMessageType.Bot);
            
            StatusMessage = "Global AI Assistant ready to help across all tabs!";
        }
    }

    /// <summary>
    /// Update the current context (tab) and provide relevant help
    /// </summary>
    public void UpdateContext(string newContext)
    {
        var previousContext = CurrentContext;
        CurrentContext = newContext;
        ContextChanged?.Invoke(newContext);

        // Provide context-specific welcome message
        if (previousContext != newContext)
        {
            var contextMessage = GetContextWelcomeMessage(newContext);
            if (!string.IsNullOrEmpty(contextMessage))
            {
                AddMessage("AI Assistant", contextMessage, ChatMessageType.System);
            }
        }

        Console.WriteLine($"üîÑ Context changed: {previousContext} ‚Üí {newContext}");
    }

    /// <summary>
    /// Send a message with context awareness
    /// </summary>
    public async Task SendMessageAsync(string message)
    {
        if (string.IsNullOrWhiteSpace(message) || IsProcessing)
            return;

        try
        {
            IsProcessing = true;
            CanSendMessage = false;
            
            var userMessage = message.Trim();
            CurrentMessage = string.Empty;

            // Add user message to chat
            AddMessage("You", userMessage, ChatMessageType.User);

            // Process the message with current context
            var response = await ProcessUserMessageWithContext(userMessage, CurrentContext);
            
            // Add AI response to chat
            AddMessage("AI Assistant", response, ChatMessageType.Bot);

            StatusMessage = "Message processed successfully";
        }
        catch (Exception ex)
        {
            AddMessage("System", $"Error processing message: {ex.Message}", ChatMessageType.System);
            StatusMessage = $"Error: {ex.Message}";
            Console.WriteLine($"‚ùå Error in SendMessageAsync: {ex.Message}");
        }
        finally
        {
            IsProcessing = false;
            CanSendMessage = true;
        }
    }

    /// <summary>
    /// Toggle AI Assistant visibility
    /// </summary>
    public void ToggleVisibility()
    {
        IsVisible = !IsVisible;
        
        if (IsVisible && Messages.Count == 0)
        {
            InitializeWelcomeMessage();
        }
        
        Console.WriteLine($"üé® AI Assistant visibility: {IsVisible}");
    }

    /// <summary>
    /// Add a quick suggestion based on current context
    /// </summary>
    public void AddContextualSuggestion()
    {
        var suggestion = GetContextualSuggestion(CurrentContext);
        if (!string.IsNullOrEmpty(suggestion))
        {
            AddMessage("AI Assistant", suggestion, ChatMessageType.Bot);
        }
    }

    /// <summary>
    /// Provide real-time template mapping assistance based on current state
    /// </summary>
    public void ProvideMappingAssistance(string templateName, string selectedCell, int mappingCount, string detectedPattern)
    {
        if (CurrentContext != "TemplateMappingView" && CurrentContext != "Template Mapping")
            return;

        string message = "";

        // Provide contextual assistance based on state
        if (!string.IsNullOrEmpty(selectedCell) && mappingCount == 0)
        {
            message = $"üéØ **Great start!** You selected cell **{selectedCell}**\n\n" +
                     "üí° **Next steps**:\n" +
                     "1. Choose a field type from the 54 smart suggestions\n" +
                     "2. Click 'üíæ Save Field Mapping' to create your first mapping\n" +
                     "3. Check 'üí° Save as reusable mapping rule' for automation\n\n" +
                     $"üìä **Template**: {templateName}\n" +
                     $"üé® **Pattern**: {detectedPattern}";
        }
        else if (mappingCount > 0 && mappingCount < 3)
        {
            message = $"üìà **Good progress!** You have **{mappingCount} mappings** created\n\n" +
                     "üöÄ **Suggestions**:\n" +
                     "‚Ä¢ Add more field mappings for complete automation\n" +
                     "‚Ä¢ Try 'üéØ Apply Mapping Rules' to see rule engine in action\n" +
                     "‚Ä¢ Use '‚öôÔ∏è Manage Rules' to view and test your rules\n\n" +
                     $"üéØ **Current selection**: {selectedCell ?? "None"}";
        }
        else if (mappingCount >= 3)
        {
            message = $"üéâ **Excellent!** You have **{mappingCount} mappings** - Template is ready!\n\n" +
                     "‚ö° **Advanced features**:\n" +
                     "‚Ä¢ Test your rules with 'üß™ Test' for visual previews\n" +
                     "‚Ä¢ Export test results to Desktop\n" +
                     "‚Ä¢ Use Tab 4 Excel selection system for bulk operations\n\n" +
                     "üèÜ **You're becoming an expert at template mapping!**";
        }

        if (!string.IsNullOrEmpty(message))
        {
            AddMessage("AI Assistant", message, ChatMessageType.Bot);
        }
    }

    /// <summary>
    /// Provide rule management guidance
    /// </summary>
    public void ProvideRuleGuidance(int activeRules, int totalRules, double successRate)
    {
        if (CurrentContext != "TemplateMappingView" && CurrentContext != "Template Mapping")
            return;

        var message = $"‚öôÔ∏è **Rule Engine Status**\n\n" +
                     $"üéØ **Active Rules**: {activeRules}/{totalRules}\n" +
                     $"üìà **Success Rate**: {successRate:P1}\n\n" +
                     "üîß **Available Actions**:\n" +
                     "‚Ä¢ **üß™ Test Rules**: See visual previews with 3-tab dialog\n" +
                     "‚Ä¢ **üü¢/üî¥ Toggle**: Activate/deactivate rules\n" +
                     "‚Ä¢ **üìä Statistics**: View performance insights\n" +
                     "‚Ä¢ **üóëÔ∏è Delete**: Remove unused rules\n\n" +
                     "üí° **Pro tip**: Test rules before applying to ensure accuracy!";

        AddMessage("AI Assistant", message, ChatMessageType.System);
    }

    /// <summary>
    /// Announce new features and improvements
    /// </summary>
    public void AnnounceEnhancements()
    {
        if (CurrentContext != "TemplateMappingView" && CurrentContext != "Template Mapping")
            return;

        var message = "üöÄ **NEW in Step 5: Template Mapping as AI Teaching Ground**\n\n" +
                     "‚ú® **Revolutionary Features**:\n\n" +
                     "üéì **Conversational Learning**: Teach me through natural conversation\n" +
                     "üñºÔ∏è **Visual Document Teaching**: Drag & drop screenshots to train patterns\n" +
                     "üìã **Template Automation**: I learn your layout preferences permanently\n" +
                     "üîÑ **Complete Workflow**: From document reading to template filling\n\n" +
                     "üéØ **How to Use the AI Teaching Ground**:\n" +
                     "‚Ä¢ Upload documents ‚Üí I learn extraction patterns\n" +
                     "‚Ä¢ Map template fields ‚Üí I remember layouts forever\n" +
                     "‚Ä¢ Create rules ‚Üí Automate bulk processing\n" +
                     "‚Ä¢ Export results ‚Üí Ready for client delivery\n\n" +
                     "üí¨ **Examples you can say**:\n" +
                     "‚Ä¢ 'I have a TNB bill with total amount RM 245.67'\n" +
                     "‚Ä¢ 'Put invoice totals in cell D15 for monthly reports'\n" +
                     "‚Ä¢ 'Learn this Excel layout for client summaries'\n\n" +
                     "üåü **This is the future of document automation!**";

        AddMessage("AI Assistant", message, ChatMessageType.Bot);
    }

    /// <summary>
    /// Provide conversational document learning assistance
    /// </summary>
    public void ProvideDocumentLearningGuidance(string documentType, int extractedFields, double confidence)
    {
        if (CurrentContext != "TemplateMappingView" && CurrentContext != "Template Mapping")
            return;

        var message = $"üéì **Document Learning Mode Activated**\n\n" +
                     $"üìÑ **Document**: {documentType}\n" +
                     $"üîç **Fields Extracted**: {extractedFields}\n" +
                     $"üìä **Confidence**: {confidence:P1}\n\n" +
                     $"üí¨ **Teach me more**:\n" +
                     $"‚Ä¢ 'The total amount is RM 245.67 in the bottom right'\n" +
                     $"‚Ä¢ 'Account number is always after \\'Account No:\\' '\n" +
                     $"‚Ä¢ 'Due date format is DD/MM/YYYY'\n\n" +
                     $"üéØ **Next Steps**:\n" +
                     $"1. Confirm/correct my extractions\n" +
                     $"2. Teach me any missing patterns\n" +
                     $"3. Choose template for automatic filling\n\n" +
                     $"üí° **Pro tip**: The more you teach me, the smarter I become!";

        AddMessage("AI Assistant", message, ChatMessageType.Bot);
    }

    /// <summary>
    /// Provide template learning workflow guidance
    /// </summary>
    public void ProvideTemplateLearningGuidance(string templateName, string templateType, int mappedFields)
    {
        if (CurrentContext != "TemplateMappingView" && CurrentContext != "Template Mapping")
            return;

        var message = $"üìã **Template Learning Mode**\n\n" +
                     $"‚úÖ **Template**: {templateName}\n" +
                     $"üé® **Type**: {templateType}\n" +
                     $"üìä **Mapped Fields**: {mappedFields}\n\n" +
                     $"üéØ **Conversational Template Teaching**:\n\n" +
                     $"**Tell me what goes where:**\n" +
                     $"‚Ä¢ 'Put total amounts in cell D15'\n" +
                     $"‚Ä¢ 'Company names go in the header section'\n" +
                     $"‚Ä¢ 'Due dates fill the right column'\n\n" +
                     $"**Ask me to help:**\n" +
                     $"‚Ä¢ 'How do I automate monthly reports?'\n" +
                     $"‚Ä¢ 'What template patterns do you know?'\n" +
                     $"‚Ä¢ 'Show me bulk processing options'\n\n" +
                     $"üöÄ **I'm learning your business workflow!**";

        AddMessage("AI Assistant", message, ChatMessageType.Bot);
    }

    /// <summary>
    /// Provide unified workflow guidance between document learning and template mapping
    /// </summary>
    public void ProvideUnifiedWorkflowGuidance()
    {
        if (CurrentContext != "TemplateMappingView" && CurrentContext != "Template Mapping")
            return;

        var message = "üåü **Complete Document Workflow Automation**\n\n" +
                     "üîÑ **How Everything Connects**:\n\n" +
                     "**1. Document Learning** üìñ\n" +
                     "‚Ä¢ Upload documents (TNB bills, invoices, reports)\n" +
                     "‚Ä¢ I learn extraction patterns through conversation\n" +
                     "‚Ä¢ Patterns saved permanently for future use\n\n" +
                     "**2. Template Mapping** üìã\n" +
                     "‚Ä¢ Upload your business templates (Excel, PDF, Word)\n" +
                     "‚Ä¢ Teach me layout through click-to-map or conversation\n" +
                     "‚Ä¢ Create reusable mapping rules for automation\n\n" +
                     "**3. Automated Processing** ‚ö°\n" +
                     "‚Ä¢ Bulk process hundreds of documents\n" +
                     "‚Ä¢ Auto-fill templates with extracted data\n" +
                     "‚Ä¢ Export ready-for-delivery reports\n\n" +
                     "üíº **Real Business Example**:\n" +
                     "1. Upload 100 TNB bills ‚Üí I extract all totals/accounts\n" +
                     "2. Map monthly expense template ‚Üí I learn cell positions\n" +
                     "3. Auto-generate 100 filled reports ‚Üí Ready for clients\n\n" +
                     "üéØ **Try saying**: 'Show me the complete workflow for my business'";

        AddMessage("AI Assistant", message, ChatMessageType.Bot);
    }

    #endregion

    #region Private Methods

    /// <summary>
    /// Process user message with context awareness
    /// </summary>
    private async Task<string> ProcessUserMessageWithContext(string userMessage, string context)
    {
        try
        {
            // Use AI Service for intelligent responses
            var response = await _aiService.ProcessChatMessageAsync(userMessage, context);
            
            // If AI response is not specific enough, check for context-specific responses
            if (response.Length < 50 || response.Contains("I understand you're asking"))
            {
                var contextResponse = GetContextSpecificResponse(userMessage, context);
                if (!string.IsNullOrEmpty(contextResponse))
                {
                    return contextResponse;
                }
            }
            
            return response;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error processing user message: {ex.Message}");
            return $"I encountered an error processing your message: {ex.Message}\n\nPlease try rephrasing your question or let me know if you need help with a specific task on the {context} tab.";
        }
    }

    /// <summary>
    /// Get context-specific response for user messages
    /// </summary>
    private string GetContextSpecificResponse(string message, string context)
    {
        var lowerMessage = message.ToLower();

        switch (context.ToLower())
        {
            case "document teaching":
                if (lowerMessage.Contains("help") || lowerMessage.Contains("how"))
                {
                    return "üéì **Document Teaching Hub Help**\n\n" +
                           "This is your AI training workspace! Here's how to use it:\n\n" +
                           "1Ô∏è‚É£ **Upload Documents**: Drag and drop documents for AI training\n" +
                           "2Ô∏è‚É£ **Choose Document Type**: Categorize (Bills, Invoices, Medical, etc.)\n" +
                           "3Ô∏è‚É£ **Review Extraction**: Check what I extracted and teach corrections\n" +
                           "4Ô∏è‚É£ **Train Patterns**: I learn from your feedback and improve\n\n" +
                           "üí° **Pro tip**: Upload multiple examples of the same document type for better learning!";
                }
                if (lowerMessage.Contains("upload") || lowerMessage.Contains("document"))
                {
                    return "üìÑ **Document Upload Training**\n\n" +
                           "I can learn from these document types:\n\n" +
                           "‚Ä¢ **Utility Bills**: TNB, electricity, water, gas bills\n" +
                           "‚Ä¢ **Invoices**: Business invoices, purchase orders\n" +
                           "‚Ä¢ **Medical Reports**: Prescriptions, lab results, doctor notes\n" +
                           "‚Ä¢ **Financial Documents**: Statements, receipts, tax forms\n\n" +
                           "**Upload multiple examples** of each type for better pattern learning!";
                }
                break;

            case "templatemapping":
                if (lowerMessage.Contains("help") || lowerMessage.Contains("how"))
                {
                    return "üó∫Ô∏è **Template Mapping as AI Teaching Ground** (Step 5)\n\n" +
                           "üéì **CONVERSATIONAL LEARNING WORKFLOW**:\n\n" +
                           "**1. Document Learning** üìñ\n" +
                           "‚Ä¢ Say: 'I have a TNB bill with total RM 245.67'\n" +
                           "‚Ä¢ I learn extraction patterns through conversation\n" +
                           "‚Ä¢ Upload documents ‚Üí I extract and ask for feedback\n\n" +
                           "**2. Template Teaching** üìã\n" +
                           "‚Ä¢ Say: 'Put total amounts in cell D15'\n" +
                           "‚Ä¢ Click cells + tell me what goes there\n" +
                           "‚Ä¢ I remember layouts permanently\n\n" +
                           "**3. Complete Automation** ‚ö°\n" +
                           "‚Ä¢ Bulk process hundreds of documents\n" +
                           "‚Ä¢ Auto-fill templates with learned patterns\n" +
                           "‚Ä¢ Export ready reports for clients\n\n" +
                           "üåü **Revolutionary**: Teach me like a human assistant!";
                }
                if (lowerMessage.Contains("learn") || lowerMessage.Contains("teach") || lowerMessage.Contains("conversation"))
                {
                    return "üéì **Conversational AI Learning**\n\n" +
                           "üí¨ **Natural Teaching Examples**:\n\n" +
                           "**Document Learning**:\n" +
                           "‚Ä¢ 'The total amount is RM 245.67 in bottom right'\n" +
                           "‚Ä¢ 'Account numbers are always after \"Account No:\"'\n" +
                           "‚Ä¢ 'TNB bills have meter readings in the middle'\n\n" +
                           "**Template Learning**:\n" +
                           "‚Ä¢ 'Put company names in the header section'\n" +
                           "‚Ä¢ 'Total amounts go in cell D15 for monthly reports'\n" +
                           "‚Ä¢ 'Due dates fill column B'\n\n" +
                           "**Workflow Questions**:\n" +
                           "‚Ä¢ 'How do I automate 100 TNB bills?'\n" +
                           "‚Ä¢ 'Show me the complete business workflow'\n" +
                           "‚Ä¢ 'What patterns do you know for invoices?'\n\n" +
                           "üöÄ **I learn like a human - just tell me what you see!**";
                }
                if (lowerMessage.Contains("excel") || lowerMessage.Contains("cell"))
                {
                    return "üìä **Excel Intelligence System**\n\n" +
                           "üéØ **I understand your Excel perfectly!** Here's what I can do:\n\n" +
                           "‚Ä¢ **Smart Cell Recognition**: A1, B5, D15, etc. with exact positioning\n" +
                           "‚Ä¢ **Pattern Learning**: Remember your layout preferences across templates\n" +
                           "‚Ä¢ **Auto-Detection**: Recognize E-commerce, Invoice, Financial patterns\n" +
                           "‚Ä¢ **Rule Engine**: 100% success rate with smart mapping automation\n\n" +
                           "üí° **Pro Tips**:\n" +
                           "‚Ä¢ Use column/row selection for bulk mapping\n" +
                           "‚Ä¢ ESC key clears any selection\n" +
                           "‚Ä¢ Rules apply automatically to similar templates";
                }
                if (lowerMessage.Contains("rule") || lowerMessage.Contains("mapping"))
                {
                    return "‚öôÔ∏è **Advanced Rule System** (Step 4 Integration)\n\n" +
                           "üéØ **Rule Management Features**:\n\n" +
                           "‚Ä¢ **Visual Rule Testing**: 3-tab enhanced dialog (üìä Summary | üéØ Preview | ‚ö° Interactive)\n" +
                           "‚Ä¢ **Smart Suggestions**: 54 dynamic field types vs 9 hardcoded\n" +
                           "‚Ä¢ **Pattern Detection**: Auto-detects template patterns\n" +
                           "‚Ä¢ **Export Results**: Test results saved to Desktop\n\n" +
                           "üîß **Quick Actions**:\n" +
                           "‚Ä¢ Click '‚öôÔ∏è Manage Rules' ‚Üí View all rules\n" +
                           "‚Ä¢ Click 'üß™ Test' ‚Üí See visual preview\n" +
                           "‚Ä¢ Toggle üü¢/üî¥ ‚Üí Activate/deactivate rules\n" +
                           "‚Ä¢ 'üìä Rule Statistics' ‚Üí Performance insights";
                }
                if (lowerMessage.Contains("field") || lowerMessage.Contains("type"))
                {
                    return "üéØ **Smart Field Mapping** (Enhanced UX)\n\n" +
                           "‚ú® **Unified Field System**:\n\n" +
                           "‚Ä¢ **Single Input**: Field Name + Type combined (no redundancy)\n" +
                           "‚Ä¢ **54 Smart Suggestions**: Database-driven field types\n" +
                           "‚Ä¢ **Usage History**: Learn from your previous mappings\n" +
                           "‚Ä¢ **AutoCompleteBox**: Type to find 'Invoice Total', 'Product SKU', etc.\n\n" +
                           "üöÄ **Recent Improvements**:\n" +
                           "‚Ä¢ Removed redundant Field Name input\n" +
                           "‚Ä¢ Enhanced pattern detection\n" +
                           "‚Ä¢ Real-time field suggestions\n" +
                           "‚Ä¢ Context-aware validation";
                }
                break;

            case "dashboard":
                if (lowerMessage.Contains("stats") || lowerMessage.Contains("data"))
                {
                    return "üìä **Dashboard Insights**\n\n" +
                           "Your current statistics show:\n\n" +
                           "‚Ä¢ Document processing activity\n" +
                           "‚Ä¢ Pattern learning success rates\n" +
                           "‚Ä¢ Recent processing history\n\n" +
                           "üí° **Want more data?** Upload more documents through the AI Learning tab or use the Dashboard action buttons!";
                }
                break;

            case "documents":
                if (lowerMessage.Contains("upload") || lowerMessage.Contains("process"))
                {
                    return "üìã **Document Management**\n\n" +
                           "This tab shows your document library. To process new documents:\n\n" +
                           "1Ô∏è‚É£ **Upload**: Go to AI Learning tab and click 'Upload Document'\n" +
                           "2Ô∏è‚É£ **Process**: I'll extract data using OCR and pattern recognition\n" +
                           "3Ô∏è‚É£ **Review**: Come back here to see results and export data\n\n" +
                           "**Need to re-process?** Just ask me and I can help!";
                }
                break;

            case "templates":
                if (lowerMessage.Contains("template") || lowerMessage.Contains("library"))
                {
                    return "üìÅ **Template Library Management**\n\n" +
                           "Organize your templates by:\n\n" +
                           "‚Ä¢ **Categories**: Monthly Reports, Client Invoices, etc.\n" +
                           "‚Ä¢ **Usage**: Track which templates you use most\n" +
                           "‚Ä¢ **Mapping**: Each template remembers its field mappings\n\n" +
                           "üí° **Get started**: Upload a template through AI Learning or Template Mapping tabs!";
                }
                break;
        }

        return string.Empty; // No context-specific response found
    }

    /// <summary>
    /// Analyze user intent with context awareness
    /// </summary>
    private async Task<string> AnalyzeUserIntentWithContext(string message, string context)
    {
        await Task.Delay(500); // Simulate processing time
        
        var lowerMessage = message.ToLower();

        // Enhanced responses with context awareness
        if (lowerMessage.Contains("total") && lowerMessage.Contains("amount"))
        {
            return $"üí∞ **Total Amount Extraction** (Context: {context})\n\n" +
                   "Great! You mentioned a total amount. Here's how I can help:\n\n" +
                   "üîç **Data Extraction**: I can find total amounts in bills, invoices, receipts\n" +
                   "üó∫Ô∏è **Template Mapping**: I can map totals to specific cells (like D15 or B8)\n" +
                   "üí± **Multi-Currency**: I work with RM, USD, EUR, and other currencies\n\n" +
                   GetContextualNextStep(context, "total amount extraction");
        }

        if (lowerMessage.Contains("template") || lowerMessage.Contains("fill") || lowerMessage.Contains("export"))
        {
            return $"üìã **Template Management** (Context: {context})\n\n" +
                   "I can help you automate template filling! Here's the workflow:\n\n" +
                   "**üéØ Template Types I Support:**\n" +
                   "‚Ä¢ Excel spreadsheets (best for cell mapping)\n" +
                   "‚Ä¢ PDF forms (field-based mapping)\n" +
                   "‚Ä¢ Word documents (bookmark mapping)\n\n" +
                   "**üì§ Complete Workflow:**\n" +
                   "1. Upload documents ‚Üí I extract data\n" +
                   "2. Upload templates ‚Üí You teach me layouts\n" +
                   "3. I automatically fill templates with extracted data\n\n" +
                   GetContextualNextStep(context, "template management");
        }

        // Step 5: Conversational Learning Patterns
        if (lowerMessage.Contains("tnb") || lowerMessage.Contains("electricity") || lowerMessage.Contains("bill"))
        {
            return $"‚ö° **TNB Bill Learning Mode** (Context: {context})\n\n" +
                   "I'm learning Malaysian utility bills! Tell me more:\n\n" +
                   "üí¨ **What I need to learn**:\n" +
                   "‚Ä¢ Where is the total amount? ('Bottom right corner')\n" +
                   "‚Ä¢ Account number location? ('Top left after Account No:')\n" +
                   "‚Ä¢ Meter reading position? ('Middle section table')\n" +
                   "‚Ä¢ Due date format? ('DD/MM/YYYY below amount')\n\n" +
                   "üéØ **Example teaching**: 'The total amount RM 245.67 is in bottom right corner next to Jumlah Perlu Dibayar'\n\n" +
                   "üöÄ **Next**: Once I learn the pattern, I can process 100s of TNB bills automatically!";
        }

        if (lowerMessage.Contains("put") && (lowerMessage.Contains("cell") || lowerMessage.Contains("column") || lowerMessage.Contains("row")))
        {
            return $"üìã **Template Layout Learning** (Context: {context})\n\n" +
                   "Perfect! You're teaching me template layouts. I understand:\n\n" +
                   "üéØ **What you said**: \"{message}\"\n\n" +
                   "üí° **I'm learning**:\n" +
                   "‚Ä¢ Field placement preferences\n" +
                   "‚Ä¢ Cell/column/row positioning\n" +
                   "‚Ä¢ Layout automation rules\n\n" +
                   "üìù **To make this permanent**:\n" +
                   "1. Click the Excel cell you mentioned\n" +
                   "2. Select the field type from dropdown\n" +
                   "3. Check 'üí° Save as reusable mapping rule'\n\n" +
                   "üöÄ **Result**: I'll remember this layout for all similar templates!";
        }

        if (lowerMessage.Contains("amount") && (lowerMessage.Contains("rm") || lowerMessage.Contains("usd") || lowerMessage.Contains("$")))
        {
            return $"üí∞ **Currency Pattern Learning** (Context: {context})\n\n" +
                   "Great! You mentioned a specific amount. I'm learning:\n\n" +
                   "üîç **What I detected**: \"{message}\"\n\n" +
                   "üìö **Currency patterns I'm learning**:\n" +
                   "‚Ä¢ RM amounts (Malaysian Ringgit)\n" +
                   "‚Ä¢ USD amounts (US Dollars)\n" +
                   "‚Ä¢ Amount positioning relative to text\n" +
                   "‚Ä¢ Number format variations\n\n" +
                   "üéØ **Help me learn more**:\n" +
                   "‚Ä¢ Where exactly do you see this amount?\n" +
                   "‚Ä¢ What text appears before/after it?\n" +
                   "‚Ä¢ Is this the total, subtotal, or tax amount?\n\n" +
                   "üí° **I'll remember this pattern for future documents!**";
        }

        if (lowerMessage.Contains("automate") || lowerMessage.Contains("bulk") || lowerMessage.Contains("100") || lowerMessage.Contains("many"))
        {
            return $"‚ö° **Bulk Automation Workflow** (Context: {context})\n\n" +
                   "üöÄ **You want bulk processing!** Here's how my learning enables automation:\n\n" +
                   "**üìñ Step 1: Teach Document Patterns**\n" +
                   "‚Ä¢ Upload 1-3 sample documents\n" +
                   "‚Ä¢ Tell me: 'Total amount is here', 'Account number is there'\n" +
                   "‚Ä¢ I learn the extraction patterns permanently\n\n" +
                   "**üìã Step 2: Teach Template Layout**\n" +
                   "‚Ä¢ Upload your business template\n" +
                   "‚Ä¢ Say: 'Put totals in D15', 'Put accounts in B8'\n" +
                   "‚Ä¢ I learn the layout permanently\n\n" +
                   "**‚ö° Step 3: Automated Processing**\n" +
                   "‚Ä¢ Upload 100s of similar documents\n" +
                   "‚Ä¢ I extract data using learned patterns\n" +
                   "‚Ä¢ I fill templates using learned layouts\n" +
                   "‚Ä¢ Export ready reports for your clients\n\n" +
                   "üéØ **Result**: 10 minutes of teaching = Hours of automation!";
        }

        if (lowerMessage.Contains("complete workflow") || lowerMessage.Contains("business workflow") || (lowerMessage.Contains("workflow") && lowerMessage.Contains("business")))
        {
            // Call the unified workflow guidance method
            ProvideUnifiedWorkflowGuidance();
            return "üîÑ Complete workflow guidance provided above! Let me know which step you'd like to start with.";
        }

        if (lowerMessage.Contains("help") || lowerMessage.Contains("how") || lowerMessage.Contains("what"))
        {
            return $"üÜò **Global AI Assistant Help** (Context: {context})\n\n" +
                   "I'm here to help you on ANY tab! Here's what I can do:\n\n" +
                   "**üéì Document Teaching**: Upload documents, train me on patterns\n" +
                   "**üó∫Ô∏è Template Mapping**: Click-to-teach Excel cell mapping\n" +
                   "**üìä Dashboard**: Insights and statistics\n" +
                   "**üìã Documents**: Review processed documents\n" +
                   "**üìÅ Templates**: Manage template library\n\n" +
                   GetContextualNextStep(context, "general help");
        }

        // Default context-aware response
        return $"ü§î **I understand** (Context: {context}): \"{message}\"\n\n" +
               "I'm still learning! Since you're on the **{context}** tab, here are some things I can help with:\n\n" +
               GetContextualSuggestions(context) + "\n\n" +
               "üí¨ **Be specific!** Tell me exactly what you want to do and I'll guide you step by step!";
    }

    /// <summary>
    /// Get welcome message when switching to a new context
    /// </summary>
    private string GetContextWelcomeMessage(string context)
    {
        return context switch
        {
            "TemplateMappingView" or "Template Mapping" => 
                "üó∫Ô∏è **Template Mapping Tab** - I can help you teach me Excel layouts and field mappings!",
            
            "Dashboard" => 
                "üìä **Dashboard Tab** - Here are your processing statistics and insights!",
            
            "Documents" => 
                "üìã **Documents Tab** - Review your processed documents or ask me to re-process any file!",
            
            "Templates" => 
                "üìÅ **Templates Tab** - Manage your template library and organize by categories!",
            
            "Document Teaching" => 
                "üéì **Document Teaching Hub** - Upload documents and train me to read your specific document types!",
            
            _ => string.Empty
        };
    }

    /// <summary>
    /// Get contextual suggestions based on current tab
    /// </summary>
    private string GetContextualSuggestions(string context)
    {
        return context switch
        {
            "TemplateMappingView" or "Template Mapping" => 
                "‚Ä¢ 'Help me map Excel fields'\n‚Ä¢ 'Show me rule management'\n‚Ä¢ 'How do I create mapping rules?'\n‚Ä¢ 'Explain the 54 field suggestions'\n‚Ä¢ 'What's new in the enhanced system?'",
            
            "Dashboard" => 
                "‚Ä¢ 'Show me my processing stats'\n‚Ä¢ 'Upload more documents'\n‚Ä¢ 'Export my data to Excel'",
            
            "Documents" => 
                "‚Ä¢ 'Re-process this document'\n‚Ä¢ 'Show me extraction results'\n‚Ä¢ 'Upload a new document'",
            
            "Templates" => 
                "‚Ä¢ 'Organize my templates'\n‚Ä¢ 'Create a new template category'\n‚Ä¢ 'Show template usage stats'",
            
            _ => "‚Ä¢ Ask me about any document processing task\n‚Ä¢ Tell me what you want to achieve\n‚Ä¢ I'll guide you to the right tab and features"
        };
    }

    /// <summary>
    /// Get next step suggestion based on context and current task
    /// </summary>
    private string GetContextualNextStep(string context, string taskType)
    {
        return context switch
        {
            "TemplateMappingView" or "Template Mapping" when taskType.Contains("template") => 
                "**Next Step**: Click 'Load Template' to upload your Excel file, then 'Start Mapping' to begin teaching!",
            
            "Dashboard" when taskType.Contains("total") => 
                "**Next Step**: Go to AI Learning tab to upload a document with total amounts!",
            
            _ => "**Next Step**: Let me know what specific task you want to accomplish and I'll guide you!"
        };
    }

    /// <summary>
    /// Get contextual suggestion for proactive help
    /// </summary>
    private string GetContextualSuggestion(string context)
    {
        return context switch
        {
            "TemplateMappingView" when Messages.Count > 5 => 
                "üí° **Quick Tip**: Upload an Excel template and I'll show you how to map data to specific cells!",
            
            "Dashboard" when Messages.Count > 3 => 
                "üìà **Insight**: Your pattern success rate shows how well I'm learning your document types!",
            
            _ => string.Empty
        };
    }

    /// <summary>
    /// Add a message to the chat history with event notification
    /// </summary>
    private void AddMessage(string sender, string content, ChatMessageType type)
    {
        var message = new ChatMessage
        {
            Id = Guid.NewGuid().ToString(),
            SenderName = sender,
            Content = content,
            Type = type,
            Timestamp = DateTime.Now,
            BackgroundColor = type switch
            {
                ChatMessageType.User => "#E3F2FD",
                ChatMessageType.Bot => "#F3E5F5", 
                ChatMessageType.System => "#FFF3E0",
                _ => "#F5F5F5"
            },
            Alignment = type == ChatMessageType.User ? 
                Avalonia.Layout.HorizontalAlignment.Right : 
                Avalonia.Layout.HorizontalAlignment.Left
        };

        Messages.Add(message);
        MessageAdded?.Invoke(message);
        
        // Keep only last 100 messages for performance
        while (Messages.Count > 100)
        {
            Messages.RemoveAt(0);
        }
        
        Console.WriteLine($"üí¨ [{CurrentContext}] {sender}: {content.Substring(0, Math.Min(50, content.Length))}...");
    }

    #endregion
}

/// <summary>
/// Simple console logger implementation for desktop application.
/// </summary>
public class SimpleConsoleLogger<T> : ILogger<T>
{
    public IDisposable? BeginScope<TState>(TState state) where TState : notnull => null;
    public bool IsEnabled(LogLevel logLevel) => true;
    
    public void Log<TState>(LogLevel logLevel, EventId eventId, TState state, Exception? exception, Func<TState, Exception?, string> formatter)
    {
        var message = formatter(state, exception);
        var timestamp = DateTime.Now.ToString("HH:mm:ss");
        var typeName = typeof(T).Name;
        Console.WriteLine($"[{timestamp}] [{typeName}] [{logLevel}] {message}");
        
        if (exception != null)
        {
            Console.WriteLine($"Exception: {exception}");
        }
    }
}